<div class="page">

  <form [formGroup]="energyForm" class="filter-card">
    <h3>Quick Report</h3>

    <div class="filter-row">
      <select formControlName="filterType">
        <option value="thisMonth">This Month</option>
        <option value="lastMonth">Last Month</option>
        <option value="custom">Custom</option>
      </select>

      <input *ngIf="energyForm.value.filterType === 'custom'" type="date" formControlName="fromDate"
        placeholder="From Date">

      <input *ngIf="energyForm.value.filterType === 'custom'" type="date" formControlName="toDate"
        placeholder="To Date">

      <div class="time-gap-input">
        <label for="timeGap">Time Gap (minutes):</label>
        <input id="timeGap" type="number" formControlName="timeGapInMinutes" min="1" max="999" placeholder="90">
      </div>
    </div>

    <div class="actions">
      <button type="button" [disabled]="!canSubmit" (click)="loadEnergySummary()">
        <span *ngIf="!loadingSummary">üìä Load Summary</span>
        <span *ngIf="loadingSummary">‚è≥ Loading...</span>
      </button>

      <button type="button" [disabled]="!canSubmit" (click)="loadUsersEnergy()">
        <span *ngIf="!loadingUsers">üë• Load Users</span>
        <span *ngIf="loadingUsers">‚è≥ Loading...</span>
      </button>
    </div>
  </form>

  <div class="error" *ngIf="errorMessage">
    ‚ö†Ô∏è {{ errorMessage }}
  </div>

  <div class="no-data" *ngIf="noSummaryData && !loadingSummary">
    No energy summary data found for selected filter.
  </div>

  <div class="card summary-card" *ngIf="energySummary && !loadingSummary">
    <div class="card-header">
      <h3>‚ö° Energy Summary</h3>
      <button class="download-btn" (click)="downloadSummaryPDF()" title="Download Summary PDF">
        üì• Export PDF
      </button>
    </div>

    <div class="summary-grid">
      <div class="summary-item">
        <span class="label">Total Energy</span>
        <strong class="value">{{ energySummary.totalKWhUsed.toFixed(2) }} KWh</strong>
      </div>

      <div class="summary-item">
        <span class="label">Total Amount</span>
        <strong class="value amount">‚Çπ {{ energySummary.totalConsumedAmount.toFixed(2) }}</strong>
      </div>

      <div class="summary-item">
        <span class="label">Total Sessions</span>
        <strong class="value">{{ energySummary.totalSessions }}</strong>
      </div>

      <div class="summary-item">
        <span class="label">Unique Drivers</span>
        <strong class="value">{{ energySummary.totalUniqueDrivers }}</strong>
      </div>

      <div class="summary-item">
        <span class="label">Repeated Users</span>
        <strong class="value">{{ energySummary.totalRepeatedUsers }}</strong>
      </div>
    </div>
  </div>

  <div class="no-data" *ngIf="noUserData && !loadingUsers">
    No users energy data found for selected filter.
  </div>

  <div class="card users-card" *ngIf="userEnergy.length && !loadingUsers">
    <div class="card-header">
      <h3>üë• Users Energy Report ({{ userEnergy.length }} users)</h3>
      <button class="download-btn" (click)="downloadUsersPDF()" title="Download Users Report PDF">
        üì• Export PDF
      </button>
    </div>

    <div class="table-wrapper">
      <table class="energy-table">
        <thead>
          <tr>
            <th>#</th>
            <th>User Name</th>
            <th>Phone Number</th>
            <th>Energy (KWh)</th>
            <th>Amount</th>
            <th>Total Sessions</th>
            <th>Last Charged</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let u of userEnergy; let i = index">
            <td class="index">{{ i + 1 }}</td>
            <td class="user-name">{{ u.userName }}</td>
            <td class="phone">{{ u.phoneNumber }}</td>
            <td class="energy">{{ u.totalKWhUsed.toFixed(2) }} KWh</td>
            <td class="amount">‚Çπ {{ u.totalConsumedAmount.toFixed(2) }}</td>
            <td class="sessions">{{ u.totalSessions }}</td>
            <td class="date">{{ u.lastChargedTime | date:'medium' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div>