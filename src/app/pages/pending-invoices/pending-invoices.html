<div class="pending-invoices-container">
    <div class="header">
        <h2>Pending Invoices</h2>
        <button class="btn-refresh" (click)="fetchPendingInvoices()" [disabled]="loading">
            <span *ngIf="!loading">üîÑ Refresh</span>
            <span *ngIf="loading">‚è≥ Loading...</span>
        </button>
    </div>

    <!-- Search Filters -->
    <div class="filter-card">
        <div class="filter-grid">
            <div class="filter-group">
                <label>Session ID</label>
                <input type="text" placeholder="Search by Session ID" [(ngModel)]="searchSessionId"
                    (input)="applyFilters()" />
            </div>
            <div class="filter-group">
                <label>Start Date</label>
                <input type="date" [(ngModel)]="startDate" (change)="applyFilters()" />
            </div>
            <div class="filter-group">
                <label>End Date</label>
                <input type="date" [(ngModel)]="endDate" (change)="applyFilters()" />
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div class="alert alert-success" *ngIf="successMessage">
        ‚úÖ {{ successMessage }}
    </div>

    <!-- Error Message -->
    <div class="alert alert-error" *ngIf="error">
        ‚ùå {{ error }}
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="loading && pendingInvoices.length === 0">
        <div class="spinner"></div>
        <p>Loading pending invoices...</p>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!loading && pendingInvoices.length === 0">
        <div class="empty-icon">üìã</div>
        <h3>No Pending Invoices</h3>
        <p>All invoices have been generated or there are no pending invoices at this time.</p>
    </div>

    <!-- Invoices Table -->
    <div class="table-container" *ngIf="!loading && pendingInvoices.length > 0">
        <table class="invoices-table">
            <thead>
                <tr>
                    <th>Session ID</th>
                    <th>Invoice No</th>
                    <th>Username</th>
                    <th>Invoice Mobile</th>
                    <th>User Mobile</th>
                    <th>Amount (‚Çπ)</th>
                    <th>Energy (kWh)</th>
                    <th>Charge Point</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let invoice of pendingInvoices">
                    <td data-label="Session ID">{{ invoice.sessionId }}</td>
                    <td data-label="Invoice No"><strong>{{ invoice.invoiceNo }}</strong></td>
                    <td data-label="Username">{{ invoice.username || 'N/A' }}</td>
                    <td data-label="Invoice Mobile">{{ invoice.invoiceMobileNumber || 'N/A' }}</td>
                    <td data-label="User Mobile">{{ invoice.userMobileNumber || 'N/A' }}</td>
                    <td data-label="Amount" class="amount">‚Çπ{{ invoice.consumedAmount | number:'1.2-2' }}</td>
                    <td data-label="Energy">{{ invoice.energyUsedKWh | number:'1.3-3' }} kWh</td>
                    <td data-label="Charge Point">{{ invoice.chargePointId }}</td>
                    <td data-label="Created At">{{ formatDate(invoice.createdAt) }}</td>

                    <!-- Actions -->
                    <td data-label="Actions" class="actions">
                        <div class="action-buttons">
                            <button class="btn btn-generate" (click)="openEditModal(invoice)"
                                [disabled]="updatingSessionId !== null">
                                ‚úèÔ∏è Update & Generate
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Invoice Count -->
    <div class="footer" *ngIf="!loading && pendingInvoices.length > 0">
        <p>Total Pending Invoices: <strong>{{ pendingInvoices.length }}</strong></p>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>üìù Update Invoice & Mark as Generated</h3>
            <button class="close-btn" (click)="closeModal()" type="button">‚úï</button>
        </div>

        <div class="modal-body" [formGroup]="editForm">
            <div class="invoice-info">
                <div class="info-row">
                    <span class="label">Session ID:</span>
                    <span class="value">{{ selectedInvoice?.sessionId }}</span>
                </div>
                <div class="info-row">
                    <span class="label">Invoice No:</span>
                    <span class="value">{{ selectedInvoice?.invoiceNo }}</span>
                </div>
                <div class="info-row">
                    <span class="label">Amount:</span>
                    <span class="value amount">‚Çπ{{ selectedInvoice?.consumedAmount | number:'1.2-2' }}</span>
                </div>
            </div>

            <div class="form-group">
                <label for="username">Username <span class="required">*</span></label>
                <input type="text" id="username" formControlName="username" placeholder="Enter username"
                    class="form-input" [class.error]="usernameError" />
                <small class="error-text" *ngIf="usernameError">{{ usernameError }}</small>
            </div>

            <div class="form-group">
                <label for="mobile">Invoice Mobile Number <span class="required">*</span></label>
                <div class="mobile-input-wrapper">
                    <span class="mobile-prefix">+91</span>
                    <input type="tel" id="mobile" formControlName="invoiceMobileNumber" placeholder="9876543210"
                        class="form-input mobile-input" [class.error]="mobileError" maxlength="10" />
                </div>
                <small class="error-text" *ngIf="mobileError">{{ mobileError }}</small>
            </div>

            <div class="warning-box">
                <p class="warning-icon">‚ö†Ô∏è</p>
                <p class="warning-text">
                    <strong>Warning:</strong> Once the invoice is generated, it cannot be updated later.
                    Please verify the username and mobile number before proceeding.
                </p>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-cancel" (click)="closeModal()" [disabled]="updatingSessionId !== null" type="button">
                ‚ùå Cancel
            </button>
            <button class="btn btn-save" (click)="saveInvoiceDetails()"
                [disabled]="updatingSessionId !== null || editForm.invalid" type="button">
                <span *ngIf="updatingSessionId === null">üíæ Update & Generate Invoice</span>
                <span *ngIf="updatingSessionId !== null">‚è≥ Updating...</span>
            </button>
        </div>
    </div>
</div>